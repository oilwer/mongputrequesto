app.factory('ItemFactory', [
  "Course",
  "$q",
  function(
    Item,
    $q
  ) {
    // a factory that gets Items
    /* if we didn't have mongrestos autogenerated $resources
      var Item = $resource(
        "/api/item/:id/",
        {_id:"@id"},
        {
          get: { method: 'GET', isArray: true },
          getById: { method: 'GET', isArray: false },
          create: { method: 'POST', isArray: true},
          update: { method: 'PUT' },
          remove: { method: 'DELETE' }
        }
      );

      var anItem = new Item();

      // insert data into anItem....

      anItem.$create(function() {
        // anItem is now an object from the DB, and we did nothing to deserve it
      });
    */
    

    var deferred = $q.defer(),
        all = [],
        itemMemory = {};

    // directly resolve all
    deferred.resolve(all);

    function getAllItems() {
      Course.get(function(allItemsInDb) {
        allItemsInDb.forEach(function(item) {
          // if we already have an item, do nothing
          if (itemMemory[item._id]) { return; }

          // remember this item
          itemMemory[item._id] = item;

          // add it to the list!
          all.push(item);
        });
      });

      return deferred.promise;
    }


    // the factory will "become" its return in other controllers/directives
    return {
      getItems : getAllItems
    };
  }
]);